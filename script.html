<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
  <div data-options='{"onOrder": "sendBitrix"}' id="calculator"></div>
  <script>

    const sendBitrix = async (el, portal) => {
      const obj = {};
      const inputs = [...el].filter(element => element.tagName === "INPUT" || element.tagName === "TEXTAREA" ? element : null);
      let valueCheckbox = ''

      inputs.forEach(input => {
        if (input.type === 'radio' && input.checked === true) {
          input.value === 'prof_brus' ? input.value = 'профилированный брус' :
            input.value === 'brevno' ? input.value = 'оцилиндрованное бревно' :
              input.value === 'kley_brus' ? input.value = 'клееный брус' :
                input.value === 'ruchnoe_brevno' ? input.value = 'бревно ручной рубки' : null;

          obj[input.name] = input.value;
        }

        if (input.type === 'checkbox' && input.checked === true) {
          input.value === 'stoimost_obsad' ? input.value = 'стоимости обсад' :
            input.value === 'podgotovka_proemov' ? input.value = 'подготовка проёмов' :
              input.value === 'montazh_obsad' ? input.value = 'сборка и монтаж обсад' :
                input.value === 'dostavka' ? input.value = 'доставка' : null;

          valueCheckbox += input.value + ',';
          obj[input.name] = valueCheckbox.split(',').slice(0, -1);
        }

        if (input.type === 'text' || input.type === 'email' || input.tagName === "TEXTAREA") {
          obj[input.name] = input.value;
        }
      });

      const response = await fetch(`https://${portal.domain}.bitrix24.ru/rest/1/${portal.token}/crm.lead.add.json`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            LAST_NAME: 'Test Last Name',
            NAME: 'Test Name',
            SECOND_NAME: 'Test Second Name',
            PHONE: [{
              VALUE: '88888'
            }],
            EMAIL: [{
              VALUE: obj.email
            }],
            COMMENTS: `Дополнительная информация: ${obj.info}`,
            SOURCE_ID: 2,
            UF_CRM_1568645931: [`Высота окна: ${obj.window_height}`,
            `Ширина окна: ${obj.window_width}`,
            `Количество окон: ${obj.window_num}`],
            UF_CRM_1568646682: [`Высота двери: ${obj.door_height}`,
            `Ширина двери: ${obj.door_width}`,
            `Количество дверей: ${obj.door_num}`],
            UF_CRM_1568647053: obj.wall_material,
            UF_CRM_1568647067: obj.wall_thickness,
            UF_CRM_1568647081: obj.calculation_items.join(','),
            UF_CRM_1568647096: obj.casing_thickness,
          }
        })
      });

      console.log(obj.calculation_items);
    }

    window.sendBitrix = sendBitrix;
  </script>
  <script src="build/calc.js"></script>
</body>

</html>